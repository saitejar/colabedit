<!--
Authentication code has been taken from Google Inc.

-->
<html>
<head>
    <meta charset="utf-8"/>
    <title>Zoodel</title>
    <link type="text/css" rel="stylesheet" href="css/trix.css" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="bootstrap/css/bootstrap.css" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
	<link type="text/css" rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.2/css/bootstrap-responsive.css" rel="stylesheet">
    <script type="text/javascript">
        var auth2 = auth2 || {};
        if (window.localStorage) {
            if (!localStorage.getItem('firstLoad')) {
                localStorage['firstLoad'] = true;
                window.location.reload();
            }
            else
                localStorage.removeItem('firstLoad');
        }
        (function () {
            var po = document.createElement('script');
            po.type = 'text/javascript';
            po.async = true;
            po.src = 'https://plus.google.com/js/client:plusone.js?onload=startApp';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(po, s);
        })();
    </script>
    <script src="js/trix-core.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>

    <script>



        var flag = 0;

        namespace = '/collabedit';
        socket = io.connect('http://' + document.domain + ':' + location.port + namespace);
        socket.on('keyPressEventSocket', function(msg) {
            console.log("Char Code: " + msg.data + ", Position : " + msg.position + ", received SID from server: " + msg.sid);
        });

        function showDialog(event) {

            var keyvalue = event.keyCode;
            if (event.keyCode === 8 || event.keyCode === 46 || event.keyCode == 32) {

            }

            if (!event.shiftKey && event.keyCode >= 65 && event.keyCode <= 90 && !event.ctrlKey) {
                keyvalue = keyvalue + 32;
            }

            var position = document.getElementById("maintext").selectionStart;


            socket.emit('keyPressEventSocket', {charc: keyvalue, charpos: position});
            /*$.ajax({
                type: "POST",
                url: $(location).attr('origin') + "/processit",
                data: JSON.stringify({charc: keyvalue, charpos: position}),
                contentType: "application/json;charset=UTF-8",
                dataType: "json",
                success: function (data) {
                    console.log("getting back from python function (keyCode):" + data);
                }
            });*/

        }


    </script>
</head>
<style>

	.whiteText{
		color: white;
	}
    #disconnect {
        box-shadow: 2px 2px 3px #888888;
        border-radius: 5px;
        cursor: hand;
    }

	#AppName{
			text-shadow: 5px 5px  #6e1d37 ;
	}

	#maintext{
		color:  #4f2f37 ;
	}
</style>

<body style="background:   #8577bb   ">

<div id="gConnect" align="center">
    <br/><br/>
    <h1 style="color: white "><span id="AppName"><b>ZOODEL</b></span> </h1><br/><h2 style="color: white ">~ A Collab editor using transactional approach</h2>
	<br/><br/><span style="color:white">- Under Prof. Sharad Mehrotra</span>
    <br/><br/><img src="images/ucilogo.png" width="200px"/><br/><br/><br/>
    <img id="customBtn" src="images/signin_button.png" onClick="signInClick()"
         alt="Sign in with Google Account" width="200px" style="cursor:pointer"/>
</div>
<div id="authOps" style="display:none">
    <br/>
    <button id="disconnect">Sign Out</button>
    <div id="profile"></div>
</div>


</body>
<script type="text/javascript">
    var Client = Client || {};
    Client.Pulse = null;

    function initializeCall(user){
        $.ajax({
            url: '/initializeCall',
            type: 'POST',
            dataType: 'json',
            contentType: "application/json;charset=UTF-8",
            data: JSON.stringify({username: user}),
            success: function (data, sStatus, jqXHR) {
                console.log(data);
            }
        });
    }

	function clearText(){
		$.ajax({
            url: '/clearTextArea',
            type: 'POST',
            dataType: 'json',
            contentType: "application/json;charset=UTF-8",
            data: JSON.stringify({username: ''}),
            success: function (data, sStatus, jqXHR) {
                console.log("cleared");
            }
        });
	}

    function deinitializeCall() {
        $.ajax({
            url: '/deinitializeCall',
            type: 'POST',
            dataType: 'json',
            contentType: "application/json;charset=UTF-8",
            data: JSON.stringify({username: ''}),
            success: function (data, sStatus, jqXHR) {
                console.log(data);
            }
        });
    }

    function heartbeat(user) {
        var times = new Date().getTime();
        $.ajax({
            url: '/heartbeat',
            type: 'POST',
            dataType: 'json',
            contentType: "application/json;charset=UTF-8",
            data: JSON.stringify({username: user, timeStamp: times}),
            success: function (jActiveUsers, sStatus, jqXHR) {
				if(jActiveUsers != 'None'){
					document.getElementById("maintext").value = jActiveUsers;
				}

                Client.RenderActiveUsers(jActiveUsers);
                Client.Pulse = setTimeout(function () {
                    heartbeat(user);
                }, 100);
            }
        });
    }

    Client.RenderActiveUsers = function (jActiveUsers) {
        //console.log("HeartBeat " + jActiveUsers);
    }
    var helper = (function () {
        var authResult = undefined;
        return {
            onSignInCallback: function (authResult) {
                for (var field in authResult) {
                }
                if (authResult['access_token']) {
                    this.authResult = authResult;
                    gapi.client.load('plus', 'v1', this.renderProfile);
                    helper.people();
                } else if (authResult['error']) {
                    console.log('There was an error: ' + authResult['error']);
                }
                console.log('authResult', authResult);
            },
            renderProfile: function () {

                var request = gapi.client.plus.people.get({'userId': 'me'});
                request.execute(function (profile) {
                    heartbeat(profile.displayName);
                    initializeCall(profile.displayName);
                    $('#profile').empty();
                    if (profile.error) {
                        $('#profile').append(profile.error);
                        return;
                    }
                    $('#profile').append(
                            $(''));
                    $('#profile').append(
                            $("<div class='container'><p class='whiteText'>Hello <b>" + profile.displayName + "</b></p><br/><p><img width='50px' src='" + profile.image.url + "'></p><input type='button' value='Clear' onclick='clearText()'> <br/><br/> <trix-editor name='content' id='maintext'></trix-editor></div>"));

                });
                $('#authOps').show('slow');
                $('#gConnect').hide();
            },
            disconnectServer: function () {
                // Revoke the server tokens
                $.ajax({
                    type: 'POST',
                    url: $(location).attr('origin') + '/disconnect',
                    async: false,
                    success: function (result) {
                        console.log('revoke response: ' + result);

                        $('#authOps').hide();
                        $('#profile').empty();
                        $('#visiblePeople').empty();
                        $('#authResult').empty();
                        $('#gConnect').show();
                    },
                    error: function (e) {
                        console.log(e);
                    }
                });
                deinitializeCall();
            },
            connectServer: function (code) {
                console.log(code);
                $.ajax({
                    type: 'POST',
                    url: $(location).attr('origin') + '/connect?state={{ STATE }}',
                    contentType: 'application/octet-stream; charset=utf-8',
                    success: function (result) {
                        console.log(result);
                        helper.people();
                        onSignInCallback(auth2.currentUser.get().getAuthResponse());
                    },
                    processData: false,
                    data: code
                });
            },
            people: function (success, failure) {
                success = success || function (result) {
                            helper.appendCircled(result);
                        };
                $.ajax({
                    type: 'GET',
                    url: $(location).attr('origin') + '/people',
                    contentType: 'application/octet-stream; charset=utf-8',
                    success: success,
                    error: failure,
                    processData: false
                });
            },
            appendCircled: function (people) {
            },
        };
    })();

    /**
     * Perform jQuery initialization and check to ensure that you updated your
     * client ID.
     */
    $(document).ready(function () {
        $('#disconnect').click(helper.disconnectServer);
        if ($('[data-clientid="YOUR_CLIENT_ID"]').length > 0) {
            alert('This sample requires your OAuth credentials (client ID) ' +
                    'from the Google APIs console:\n' +
                    '    https://code.google.com/apis/console/#:access\n\n' +
                    'Find and replace YOUR_CLIENT_ID with your client ID and ' +
                    'YOUR_CLIENT_SECRET with your client secret in the project sources.'
            );
        }
    });

    /**
     * Called after the Google client library has loaded.
     */
    function startApp() {
        gapi.load('auth2', function () {

            // Retrieve the singleton for the GoogleAuth library and setup the client.
            gapi.auth2.init({
                client_id: '{{ CLIENT_ID }}',
                cookiepolicy: 'single_host_origin',
                fetch_basic_profile: false,
                scope: 'https://www.googleapis.com/auth/plus.login'
            }).then(function () {
                console.log('init');
                auth2 = gapi.auth2.getAuthInstance();
                auth2.then(function () {
                    var isAuthedCallback = function () {
                        onSignInCallback(auth2.currentUser.get().getAuthResponse())
                    }
                    helper.people(isAuthedCallback);
                });
            });
        });
    }

    /**
     * Either signs the user in or authorizes the back-end.
     */
    function signInClick() {

        var signIn = function (result) {
            auth2.signIn().then(
                    function (googleUser) {
                        onSignInCallback(googleUser.getAuthResponse());
                    }, function (error) {
                        alert(JSON.stringify(error, undefined, 2));
                    });
        };

        var reauthorize = function () {
            auth2.grantOfflineAccess().then(
                    function (result) {
                        helper.connectServer(result.code);
                    });
        };

        helper.people(signIn, reauthorize);
    }

    function onSignInCallback(authResult) {
        helper.onSignInCallback(authResult);
    }
</script>


</html>